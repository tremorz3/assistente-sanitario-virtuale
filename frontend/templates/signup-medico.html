{% extends "layouts/base.html" %}

{% block title %}Registrazione Medico - Salus AI{% endblock %}

{% block content %}
<div class="form-container">
    <form class="form-box" action="/pagina-registrazione-medico" method="post">
        <h2>Diventa un Medico Partner</h2>

        {% if error %}
            <div class="form-error">{{ error }}</div>
        {% endif %}

        <div class="form-group">
            <label for="nome">Nome</label>
            <input type="text" id="nome" name="nome" required>
        </div>
        <div class="form-group">
            <label for="cognome">Cognome</label>
            <input type="text" id="cognome" name="cognome" required>
        </div>
        <div class="form-group">
            <label for="citta">Città</label>
            <input type="text" id="citta" name="citta" required>
        </div>
        <div class="form-group">
            <label for="indirizzo_studio_visual">Indirizzo Studio</label>
            <div class="autocomplete-container">
                <input type="text" id="indirizzo_studio_visual" placeholder="Digita e seleziona un indirizzo" autocomplete="off" class="form-control">
                <input type="hidden" id="indirizzo_studio_hidden" name="indirizzo_studio" required>
                <div class="autocomplete-items" id="address-suggestions"></div>
            </div>
        </div>
        <div class="form-group">
            <label for="telefono">Telefono</label>
            <input type="tel" id="telefono" name="telefono" placeholder="10 cifre" required minlength="10" maxlength="10">
        </div>
        <div class="form-group">
            <label for="specializzazione">Specializzazione</label>
            <select id="specializzazione" name="specializzazione_id" required>
                <option value="" disabled selected>Seleziona...</option>
                {% for spec in specializzazioni %}
                <option value="{{ spec.id }}">{{ spec.nome }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="ordine_iscrizione">Ordine di Iscrizione</label>
            <input type="text" id="ordine_iscrizione" name="ordine_iscrizione" placeholder="Es. Ordine dei Medici di Roma" required>
        </div>
        <div class="form-group">
            <label for="numero_iscrizione">Numero di Iscrizione</label>
            <input type="text" id="numero_iscrizione" name="numero_iscrizione" required>
        </div>
        <div class="form-group">
            <label for="provincia_iscrizione">Provincia di Iscrizione</label>
            <input type="text" id="provincia_iscrizione" name="provincia_iscrizione" placeholder="Es. RM" required>
        </div>
        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" required>
        </div>
        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" placeholder="Minimo 8 caratteri" required minlength="8">
        </div>
        
        <button type="submit" class="btn-form">Registrati come Medico</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    // La logica per l'autocomplete dell'indirizzo rimane identica,
    // si integrerà perfettamente con i nuovi stili.
    document.addEventListener('DOMContentLoaded', function() {
        const addressInputVisual = document.getElementById('indirizzo_studio_visual');
        const addressInputHidden = document.getElementById('indirizzo_studio_hidden');
        const suggestionsContainer = document.getElementById('address-suggestions');
        let debounceTimer;

        addressInputVisual.addEventListener('input', function() {
            addressInputHidden.value = ''; 
            const query = this.value;
            clearTimeout(debounceTimer);
            suggestionsContainer.innerHTML = '';

            if (query.length < 3) return;

            debounceTimer = setTimeout(() => {
                fetch(`/api/autocomplete-address?query=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(suggestions => {
                        suggestionsContainer.innerHTML = '';
                        suggestions.forEach(suggestion => {
                            const suggestionDiv = document.createElement('div');
                            suggestionDiv.textContent = suggestion.display_address; 
                            suggestionDiv.addEventListener('click', function() {
                                addressInputVisual.value = suggestion.display_address;
                                addressInputHidden.value = suggestion.validation_address;
                                suggestionsContainer.innerHTML = '';
                            });
                            suggestionsContainer.appendChild(suggestionDiv);
                        });
                    })
                    .catch(error => console.error('Errore:', error));
            }, 300);
        });

        document.querySelector('form').addEventListener('submit', function(event) {
            if (addressInputHidden.value.trim() === '') {
                event.preventDefault();
                alert('Per favore, seleziona un indirizzo valido dalla lista dei suggerimenti.');
            }
        });

        document.addEventListener('click', (e) => {
            if (e.target !== addressInputVisual) {
                suggestionsContainer.innerHTML = '';
            }
        });
    });
</script>
{% endblock %}