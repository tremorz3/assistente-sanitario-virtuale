<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Mia Dashboard</title>
    <script src="/static/js/app.js" defer></script>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: auto; padding: 20px; background-color: #f4f4f9; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .header h1 { color: #333; margin: 0; }
        #logout-button { background-color: #dc3545; color: white; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; }
        .appuntamento-card { background-color: white; border: 1px solid #ddd; border-left: 5px solid #007bff; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .appuntamento-card.completato { border-left-color: #28a745; }
        .appuntamento-card.cancellato { border-left-color: #6c757d; text-decoration: line-through; }
        .appuntamento-card h3 { margin: 0 0 10px; }
        .actions button { margin-right: 10px; padding: 5px 10px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer; }
        .actions button:disabled { background-color: #e9ecef; cursor: not-allowed; }
        .actions .btn-review { background-color: #28a745; color: white; border-color: #28a745; }
        .actions .btn-cancel { background-color: #ffc107; color: #212529; border-color: #ffc107; }
        /* Stili per il modale di recensione */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: center; }
        .star-rating input[type="radio"] { display: none; }
        .star-rating label { font-size: 2em; color: #ccc; cursor: pointer; }
        .star-rating input[type="radio"]:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: #f90; }
        #review-form textarea { width: 100%; min-height: 80px; margin-top: 15px; }
        #review-form button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>La Mia Dashboard</h1>
        <button id="logout-button">Logout</button>
    </div>

    <div id="user-info">
        <h2 id="welcome-message">Ciao, Caricamento...</h2>
    </div>


    <h2>Appuntamenti Futuri</h2>
    <div id="appuntamenti-futuri"><p>Caricamento...</p></div>

    <h2>Appuntamenti Passati</h2>
    <div id="appuntamenti-passati"><p>Caricamento...</p></div>

    <div id="review-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeReviewModal()">&times;</span>
            <h2>Lascia una Recensione</h2>
            <form id="review-form">
                <input type="hidden" id="review-prenotazione-id" name="prenotazione_id">
                <p>Valuta la tua visita:</p>
                <div class="star-rating">
                    <input type="radio" id="star5" name="punteggio" value="5" required/><label for="star5" title="5 stelle">★</label>
                    <input type="radio" id="star4" name="punteggio" value="4" /><label for="star4" title="4 stelle">★</label>
                    <input type="radio" id="star3" name="punteggio" value="3" /><label for="star3" title="3 stelle">★</label>
                    <input type="radio" id="star2" name="punteggio" value="2" /><label for="star2" title="2 stelle">★</label>
                    <input type="radio" id="star1" name="punteggio" value="1" /><label for="star1" title="1 stella">★</label>
                </div>
                <textarea name="commento" placeholder="Lascia un commento (opzionale)..."></textarea>
                <button type="submit">Invia Recensione</button>
            </form>
            <div id="review-error" style="color: red; margin-top: 10px;"></div>
        </div>
    </div>
    <div id="notifica"></div>

    <script>
        // --- LOGICA ESEGUITA AL CARICAMENTO DELLA PAGINA ---
        window.addEventListener('DOMContentLoaded', async () => {
            if (!localStorage.getItem('user_token')) {
                window.location.href = '/pagina-login';
                return;
            }
            
            try {
                // 1. Carica i dati dell'utente
                const userData = await callApi('/me');
                document.getElementById('welcome-message').textContent = `Ciao, ${userData.nome}!`;
                
                // 2. Eseguiamo le chiamate per prenotazioni e valutazioni in parallelo per velocità
                const [prenotazioni, valutazioni] = await Promise.all([
                    callApi('/api/prenotazioni/me'),
                    callApi('/api/valutazioni') 
                ]);


                // Creiamo un Set con gli ID delle prenotazioni già valutate per una ricerca veloce
                const prenotazioniValutateIds = new Set(valutazioni.map(v => v.prenotazione_id));
                
                
                const futuriContainer = document.getElementById('appuntamenti-futuri');
                const passatiContainer = document.getElementById('appuntamenti-passati');
                futuriContainer.innerHTML = '';
                passatiContainer.innerHTML = '';

                const adesso = new Date();

                prenotazioni.forEach(p => {
                    const dataVisita = new Date(p.data_ora_inizio);
                    const card = document.createElement('div');
                    card.className = 'appuntamento-card';
                    
                    let actionsHtml = '<div class="actions">';
                    if (p.stato === 'Confermata' && dataVisita > adesso) {
                        actionsHtml += `<button class="btn-cancel" onclick="handleCancelClick(${p.id})">Cancella</button>`;
                    }
                    if (p.stato === 'Completata') {
                        // --- LOGICA AGGIORNATA ---
                        // Controlliamo se l'ID della prenotazione è nel nostro Set
                        if (prenotazioniValutateIds.has(p.id)) {
                            actionsHtml += `<button class="btn-review" disabled>Recensito</button>`;
                        } else {
                            actionsHtml += `<button class="btn-review" onclick="showReviewModal(${p.id})">Lascia una Recensione</button>`;
                        }
                    }
                    actionsHtml += '</div>';

                    card.innerHTML = `
                        <h3>Dr. ${p.medico_nome} ${p.medico_cognome}</h3>
                        <p><strong>Data:</strong> ${dataVisita.toLocaleDateString('it-IT', {day: '2-digit', month: 'long', year: 'numeric'})}</p>
                        <p><strong>Ora:</strong> ${dataVisita.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'})}</p>
                        <p><strong>Stato:</strong> ${p.stato}</p>
                        ${actionsHtml}
                    `;
                    
                    if (p.stato === 'Completata' || p.stato === 'Cancellata' || dataVisita < adesso) {
                        if(p.stato === 'Completata') card.classList.add('completato');
                        if(p.stato === 'Cancellata') card.classList.add('cancellato');
                        passatiContainer.appendChild(card);
                    } else {
                        futuriContainer.appendChild(card);
                    }
                });

                if(futuriContainer.innerHTML === '') futuriContainer.innerHTML = '<p>Nessun appuntamento futuro.</p>';
                if(passatiContainer.innerHTML === '') passatiContainer.innerHTML = '<p>Nessun appuntamento passato.</p>';

            } catch (error) {
                console.error("Errore nel caricamento della dashboard:", error.message);
            }
            document.getElementById('logout-button').addEventListener('click', logout);
        });

        const reviewModal = document.getElementById('review-modal');
        const reviewForm = document.getElementById('review-form');
        const reviewErrorDiv = document.getElementById('review-error');

        function showReviewModal(prenotazioneId) {
            reviewForm.reset();
            reviewErrorDiv.textContent = '';
            document.getElementById('review-prenotazione-id').value = prenotazioneId;
            reviewModal.style.display = 'block';
        }

        function closeReviewModal() {
            reviewModal.style.display = 'none';
        }

        reviewForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            reviewErrorDiv.textContent = '';
            const formData = new FormData(reviewForm);
            const payload = {
                prenotazione_id: parseInt(formData.get('prenotazione_id')),
                punteggio: parseInt(formData.get('punteggio')),
                commento: formData.get('commento')
            };

            try {
                await callApi('/api/valutazioni', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                closeReviewModal();
                alert('Grazie per la tua recensione!');
                window.location.reload(); // Ricarica per aggiornare lo stato del pulsante
            } catch (error) {
                reviewErrorDiv.textContent = `Errore: ${error.message}`;
            }
        });

        // Funzioni per le azioni (verranno implementate nel dettaglio in seguito)
        async function handleCancelClick(prenotazioneId) {
            if (!confirm("Sei sicuro di voler cancellare questa prenotazione?")) return;
            try {
                await callApi(`/api/prenotazioni/${prenotazioneId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stato: 'Cancellata' })
                });
                alert('Prenotazione cancellata con successo!');
                window.location.reload();
            } catch (error) {
                alert(`Errore: ${error.message}`);
            }
        }

        
    </script>
</body>
</html>