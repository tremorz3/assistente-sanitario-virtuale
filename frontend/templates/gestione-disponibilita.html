{% extends "layouts/base.html" %}

{% block title %}Gestione Disponibilità - MediClick{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Gestione Disponibilità</h1>
    <p>Aggiungi nuove fasce orarie in cui sei disponibile e cancella quelle future non ancora prenotate.</p>
</div>

<div class="dashboard-grid grid-2-cols">
    <div class="card">
        <h2>Aggiungi Slot</h2>
        <form id="add-disponibilita-form">
            <div class="form-group">
                <label for="data_visita">Data</label>
                <input type="date" id="data_visita" name="data_visita" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="ora_inizio">Orario di Inizio</label>
                <input type="time" id="ora_inizio" name="ora_inizio" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="ora_fine">Orario di Fine</label>
                <input type="time" id="ora_fine" name="ora_fine" class="form-control" required>
            </div>
            <button type="submit" class="btn-form">Aggiungi Disponibilità</button>
        </form>
    </div>
    <div class="card">
        <h2>Le Tue Disponibilità</h2>
        <ul id="disponibilita-container" class="disponibilita-list">
            <li>Caricamento...</li>
        </ul>
    </div>
</div>

<div id="notifica" class="form-error hidden" style="margin-top: 20px;"></div>

{% endblock %}

{% block scripts %}
<script>
    const disponibilitaContainer = document.getElementById('disponibilita-container');
    const addForm = document.getElementById('add-disponibilita-form');

    // La logica di caricamento rimane la stessa
    async function loadDisponibilita() {
        disponibilitaContainer.innerHTML = '<li>Caricamento...</li>';
        try {
            const userData = await callApi('/me');
            if (userData.tipo_utente !== 'medico' || !userData.medico_id) {
                throw new Error("Accesso non autorizzato o profilo medico non valido.");
            }
            
            const medicoId = userData.medico_id;
            const disponibilita = await callApi(`/medici/api/${medicoId}/disponibilita?solo_libere=false`);
            
            disponibilitaContainer.innerHTML = '';
            if (disponibilita.length === 0) {
                disponibilitaContainer.innerHTML = '<li>Nessuna disponibilità impostata.</li>';
                return;
            }

            disponibilita.sort((a, b) => new Date(b.data_ora_inizio) - new Date(a.data_ora_inizio));

            disponibilita.forEach(slot => {
                const li = document.createElement('li');
                const dataInizio = new Date(slot.data_ora_inizio);
                li.innerHTML = `<span>${dataInizio.toLocaleString('it-IT', { dateStyle: 'full', timeStyle: 'short' })}</span>`;
                
                if(slot.is_prenotato) {
                    li.classList.add('prenotato');
                    li.innerHTML += '<span class="status-prenotato">(Prenotato)</span>';
                } else {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn-delete actions';
                    deleteBtn.textContent = 'Cancella';
                    deleteBtn.onclick = () => handleDeleteClick(slot.id);
                    li.appendChild(deleteBtn);
                }
                disponibilitaContainer.appendChild(li);
            });

        } catch (error) {
            SalusNotifier.alert(error.message, 'Errore');
        }
    }

    // --- MODIFICA QUI: Sostituzione delle notifiche nel form ---
    addForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const dataVisita = document.getElementById('data_visita').value;
        const oraInizio = document.getElementById('ora_inizio').value;
        const oraFine = document.getElementById('ora_fine').value;

        const dataOraInizioCompleta = `${dataVisita}T${oraInizio}`;
        const dataOraFineCompleta = `${dataVisita}T${oraFine}`;

        const oggi = new Date();
        oggi.setHours(0, 0, 0, 0);

        if (new Date(dataOraInizioCompleta) < oggi) {
            return SalusNotifier.alert('Non è possibile inserire una disponibilità per una data passata.', 'Errore di Validazione');
        }
        if (new Date(dataOraFineCompleta) <= new Date(dataOraInizioCompleta)) {
            return SalusNotifier.alert("L'orario di fine deve essere successivo a quello di inizio.", 'Errore di Validazione');
        }
        
        const payload = { data_ora_inizio: dataOraInizioCompleta, data_ora_fine: dataOraFineCompleta };

        try {
            await callApi('/api/disponibilita', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            SalusNotifier.alert('Disponibilità aggiunta con successo!', 'Successo');
            addForm.reset();
            loadDisponibilita();
        } catch (error) {
            SalusNotifier.alert(error.message, 'Errore');
        }
    });

    // --- MODIFICA QUI: Sostituzione di confirm() e alert() ---
    async function handleDeleteClick(disponibilitaId) {
        const userConfirmed = await SalusNotifier.confirm(
            "Sei sicuro di voler cancellare questa fascia oraria? L'azione non può essere annullata.",
            "Conferma Cancellazione Slot"
        );

        if (userConfirmed) {
            try {
                await callApi(`/api/disponibilita/${disponibilitaId}`, { method: 'DELETE' });
                SalusNotifier.alert('Disponibilità cancellata.', 'Successo');
                loadDisponibilita();
            } catch(error) {
                SalusNotifier.alert(error.message, 'Errore');
            }
        }
    }
    
    // Questa funzione non è più necessaria perché il notifier è globale.
    // function notifica(type, message) { ... }

    window.addEventListener('DOMContentLoaded', loadDisponibilita);
</script>
<style>
    /* Stili specifici per questa pagina */
    .disponibilita-list {
        list-style: none;
        padding: 0;
        max-height: 400px; /* Altezza massima prima dello scroll */
        overflow-y: auto;
    }
    .disponibilita-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 5px;
        border-bottom: 1px solid var(--border-color);
    }
    .disponibilita-list li.prenotato {
        color: var(--text-secondary);
    }
    .status-prenotato {
        font-style: italic;
    }
    .btn-delete {
        padding: 5px 10px;
        background-color: #dc3545;
        border: 1px solid #dc3545;
        color: white;
    }
</style>
{% endblock %}