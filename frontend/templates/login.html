{% extends "layouts/base.html" %}

{% block title %}Login - MediClick{% endblock %}

{% block content %}
<div class="form-container">
    <form class="form-box" id="login-form">
        <h2>Accedi al Tuo Account</h2>

        {% if success_message %}
            <div class="form-success">{{ success_message }}</div>
        {% endif %}
        
        <div id="error-message" class="form-error hidden"></div>

        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" placeholder="iltuoindirizzo@email.com" required>
        </div>
        
        <div class="form-group">
            <label for="password">Password</label>
            <div class="password-container">
                <input type="password" id="password" name="password" placeholder="••••••••" required>
                <span class="password-toggle-icon"></span>
            </div>
        </div>

        <button type="submit" class="btn-form">Accedi</button>
        
        <p class="form-switch">
            Non hai un account? <a href="/pagina-registrazione-paziente">Registrati</a>
        </p>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    const loginForm = document.getElementById('login-form');
    const errorMessageDiv = document.getElementById('error-message');

    loginForm.addEventListener('submit', async (event) => {
        event.preventDefault(); // Impedisce il ricaricamento della pagina
        errorMessageDiv.classList.add('hidden'); // Nasconde il vecchio errore
        errorMessageDiv.textContent = '';
        
        // Raccoglie i dati dal form e li converte in un oggetto JavaScript
        const formData = new FormData(loginForm);
        const data = Object.fromEntries(formData.entries());

        try {
            // Esegue la chiamata API, inviando i dati come JSON
            const response = await fetch('/pagina-login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json' // Specifica che stiamo inviando JSON
                },
                body: JSON.stringify(data) // Converte l'oggetto JS in una stringa JSON
            });
            
            // Attende la risposta e la converte da JSON
            const responseData = await response.json();

            if (response.ok) {
                // Se il login ha successo (status 2xx)
                localStorage.setItem('user_token', responseData.token.access_token);
                
                if (responseData.tipo_utente === 'medico') {
                    window.location.href = '/dashboard-medico';
                } else {
                    window.location.href = '/profilo';
                }
            } else {
                // Se il login fallisce (status 4xx, 5xx)
                // MODIFICA: Gestisce correttamente il messaggio di errore
                if (typeof responseData.detail === 'string') {
                    // Se il dettaglio è una semplice stringa (es. "Email o password non validi")
                    errorMessageDiv.textContent = responseData.detail;
                } else {
                    // Se il dettaglio è complesso (come un errore di validazione 422)
                    errorMessageDiv.textContent = 'Dati non validi. Controlla i campi inseriti.';
                }
                errorMessageDiv.classList.remove('hidden'); // Mostra il box dell'errore
            }
        } catch (error) {
            // Errore di rete o di connessione
            console.error('Errore durante il login:', error);
            errorMessageDiv.textContent = 'Impossibile connettersi al server. Riprova più tardi.';
            errorMessageDiv.classList.remove('hidden');
        }
    });
</script>
{% endblock %}