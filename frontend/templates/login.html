{% extends "layouts/base.html" %}
{% from "partials/_form_macros.html" import form_container, show_success, form_field, password_field, submit_button, form_switch_link %}

{% block title %}Login - MediClick{% endblock %}

{% block content %}
{% call form_container(form_class="form-box", action="", method="post", id="login-form") %}
    <h2>Accedi al Tuo Account</h2>
    
    {{ show_success(success_message) }}
    <div id="error-message" class="form-error hidden"></div>

    {{ form_field("Email", "email", type="email", placeholder="iltuoindirizzo@email.com", required=True) }}
    {{ password_field("Password", "password", placeholder="••••••••") }}
    
    {{ submit_button("Accedi") }}
    {{ form_switch_link("Non hai un account?", "/pagina-registrazione-paziente", "Registrati") }}
{% endcall %}
{% endblock %}

{% block scripts %}
<script>
    const loginForm = document.getElementById('login-form');
    const errorMessageDiv = document.getElementById('error-message');

    loginForm.addEventListener('submit', async (event) => {
        event.preventDefault(); // Impedisce il ricaricamento della pagina
        errorMessageDiv.classList.add('hidden'); // Nasconde il vecchio errore
        errorMessageDiv.textContent = '';
        
        // Raccoglie i dati dal form e li converte in un oggetto JavaScript
        const formData = new FormData(loginForm);
        const data = Object.fromEntries(formData.entries());

        try {
            // Esegue la chiamata API, inviando i dati come JSON
            const response = await fetch('/pagina-login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json' // Specifica che stiamo inviando JSON
                },
                body: JSON.stringify(data) // Converte l'oggetto JS in una stringa JSON
            });
            
            // Attende la risposta e la converte da JSON
            const responseData = await response.json();

            if (response.ok) {
                // Se il login ha successo (status 2xx)
                localStorage.setItem('user_token', responseData.token.access_token);
                
                if (responseData.tipo_utente === 'medico') {
                    window.location.href = '/dashboard-medico';
                } else {
                    window.location.href = '/profilo';
                }
            } else {
                // Se il login fallisce (status 4xx, 5xx)
                // MODIFICA: Gestisce correttamente il messaggio di errore
                if (typeof responseData.detail === 'string') {
                    // Se il dettaglio è una semplice stringa (es. "Email o password non validi")
                    errorMessageDiv.textContent = responseData.detail;
                } else {
                    // Se il dettaglio è complesso (come un errore di validazione 422)
                    errorMessageDiv.textContent = 'Dati non validi. Controlla i campi inseriti.';
                }
                errorMessageDiv.classList.remove('hidden'); // Mostra il box dell'errore
            }
        } catch (error) {
            // Errore di rete o di connessione
            console.error('Errore durante il login:', error);
            errorMessageDiv.textContent = 'Impossibile connettersi al server. Riprova più tardi.';
            errorMessageDiv.classList.remove('hidden');
        }
    });
</script>
{% endblock %}