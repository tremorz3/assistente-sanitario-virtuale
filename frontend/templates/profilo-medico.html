{% extends "layouts/base.html" %}

{% block title %}Profilo Medico - MediClick{% endblock %}

{% block content %}
<div class="page-header">
    <h1 id="medico-nome">Caricamento...</h1>
</div>

<div class="profilo-medico-grid">
    <div class="card">
        <h2>Informazioni Dettagliate</h2>
        <div class="info-medico">
            <p><strong>Specializzazione:</strong> <span id="medico-specializzazione">...</span></p>
            <p><strong>Città:</strong> <span id="medico-citta">...</span></p>
            <p><strong>Indirizzo Studio:</strong> <span id="medico-indirizzo">...</span></p>
            <p class="punteggio" style="font-size: 1.2rem;">Punteggio Medio: <span id="medico-punteggio">...</span> / 5.00</p>
        </div>
    </div>

    <div class="card">
        <h2>Prenota una Visita</h2>
        <p id="auth-message" class="hidden" style="margin-bottom: 15px;">
            <a href="/pagina-login">Accedi</a> per prenotare una visita.
        </p>
        <ul id="disponibilita-lista">
            <li>Caricamento disponibilità...</li>
        </ul>
    </div>
</div>
    
<div id="notifica" class="hidden"></div>

<div id="booking-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeBookingModal()">&times;</span>
        <h2>Conferma Prenotazione</h2>
        <p>Stai per prenotare una visita per:</p>
        <p id="booking-modal-details" style="font-weight: 600; color: var(--primary-color);"></p>
        <form id="booking-form">
            <div class="form-group" style="margin-top: 20px;">
                <label for="note_paziente">Note per il medico (opzionale)</label>
                <textarea id="note_paziente" name="note_paziente" class="form-control" rows="3" placeholder="Es. motivo della visita, farmaci assunti, allergie..."></textarea>
            </div>
            <button type="submit" class="btn-form">Conferma la mia prenotazione</button>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const bookingModal = document.getElementById('booking-modal');
    const bookingForm = document.getElementById('booking-form');
    const bookingDetails = document.getElementById('booking-modal-details');
    const notesInput = document.getElementById('note_paziente');
    
    // Variabile globale per tenere traccia dello slot selezionato
    let selectedSlotId = null;

    // La logica di caricamento rimane la stessa...
    window.addEventListener('DOMContentLoaded', async () => {
        // ... (tutto il codice di caricamento della pagina fino alla fine)
        const pathParts = window.location.pathname.split('/');
        const medicoId = pathParts[pathParts.length - 1];
        
        const containerDisponibilita = document.getElementById('disponibilita-lista');
        const isLoggedIn = !!localStorage.getItem('user_token');
        if(!isLoggedIn) {
            document.getElementById('auth-message').classList.remove('hidden');
        }

        try {
            const medico = await callApi(`/medici/api/${medicoId}/details`);

            document.getElementById('medico-nome').textContent = `Dr. ${medico.nome} ${medico.cognome}`;
            document.getElementById('medico-specializzazione').textContent = medico.specializzazione_nome;
            document.getElementById('medico-citta').textContent = medico.citta;
            document.getElementById('medico-indirizzo').textContent = medico.indirizzo_studio;
            document.getElementById('medico-punteggio').textContent = medico.punteggio_medio.toFixed(2);
            document.title = `Profilo Dr. ${medico.nome} ${medico.cognome} - MediClick`;
            
            const disponibilita = await callApi(`/medici/api/${medicoId}/disponibilita?solo_libere=true`);
            
            containerDisponibilita.innerHTML = ''; 
            if (disponibilita.length === 0) {
                containerDisponibilita.innerHTML = '<li class="disabled">Nessuna disponibilità trovata.</li>';
            } else {
                disponibilita.forEach(slot => {
                    const li = document.createElement('li');
                    const dataInizio = new Date(slot.data_ora_inizio);
                    li.textContent = `${dataInizio.toLocaleDateString('it-IT', { dateStyle: 'long' })} - ${dataInizio.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}`;
                    
                    if (isLoggedIn) {
                        li.dataset.slotId = slot.id;
                        // MODIFICA: La funzione ora apre il modale
                        li.addEventListener('click', () => openBookingModal(slot.id, li.textContent));
                    } else {
                        li.classList.add('disabled');
                    }
                    containerDisponibilita.appendChild(li);
                });
            }

        } catch (error) {
            console.error("Errore caricamento dati medico:", error);
            document.querySelector('.page-header').innerHTML = '<h1>Medico non trovato</h1><p>Errore nel recupero delle informazioni.</p>';
        }
    });

    /**
     * Apre il modale di prenotazione, impostando i dati corretti.
     * @param {number} slotId - L'ID dello slot di disponibilità.
     * @param {string} slotText - Il testo descrittivo dello slot.
     */
    function openBookingModal(slotId, slotText) {
        selectedSlotId = slotId;
        bookingDetails.textContent = slotText;
        bookingForm.reset();
        bookingModal.style.display = 'block';
    }

    /**
     * Chiude il modale di prenotazione.
     */
    function closeBookingModal() {
        bookingModal.style.display = 'none';
        selectedSlotId = null;
    }

    // Aggiungiamo il listener per l'invio del form del modale
    bookingForm.addEventListener('submit', async (event) => {
        event.preventDefault(); // Impedisce il ricaricamento della pagina
        if (!selectedSlotId) return;

        const notePaziente = notesInput.value.trim();

        // Creiamo il payload per l'API, includendo le note
        const payload = {
            disponibilita_id: parseInt(selectedSlotId),
            note_paziente: notePaziente
        };

        try {
            await callApi('/api/prenotazioni', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            closeBookingModal(); // Chiudiamo il modale dopo la chiamata
            SalusNotifier.alert('Prenotazione confermata con successo! Sarai reindirizzato al tuo profilo.', 'Prenotazione Effettuata');
            setTimeout(() => window.location.href = '/profilo', 2000);

        } catch(error) {
            console.error("Errore prenotazione:", error);
            closeBookingModal();
            SalusNotifier.alert(`Errore: ${error.message}`, 'Errore di Prenotazione');
        }
    });

</script>
{% endblock %}