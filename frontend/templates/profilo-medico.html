{% extends "layouts/base.html" %}

{% block title %}Profilo Medico - MediClick{% endblock %}

{% block content %}
<div class="page-header">
    <h1 id="medico-nome">Caricamento...</h1>
</div>

<div class="profilo-medico-grid">
    <div class="card">
        <h2>Informazioni Dettagliate</h2>
        <div class="info-medico">
            <p><strong>Specializzazione:</strong> <span id="medico-specializzazione">...</span></p>
            <p><strong>Città:</strong> <span id="medico-citta">...</span></p>
            <p><strong>Indirizzo Studio:</strong> <span id="medico-indirizzo">...</span></p>
            <p class="punteggio" style="font-size: 1.2rem;">Punteggio Medio: <span id="medico-punteggio">...</span> / 5.00</p>
        </div>
    </div>

    <div class="card">
        <h2>Prenota una Visita</h2>
        <p id="auth-message" class="hidden" style="margin-bottom: 15px;">
            <a href="/pagina-login">Accedi</a> per prenotare una visita.
        </p>
        <ul id="disponibilita-lista">
            <li>Caricamento disponibilità...</li>
        </ul>
    </div>
</div>

<div class="card" id="recensioni-medico" style="margin-top: 20px;">
    <h2>Recensioni dei Pazienti</h2>
    <div id="recensioni-lista">
        <p>Caricamento recensioni...</p>
    </div>
</div>
    
<div id="notifica" class="hidden"></div>

<div id="booking-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeBookingModal()">&times;</span>
        <h2>Conferma Prenotazione</h2>
        <p>Stai per prenotare una visita per:</p>
        <p id="booking-modal-details" style="font-weight: 600; color: var(--primary-color);"></p>
        <form id="booking-form">
            <div class="form-group" style="margin-top: 20px;">
                <label for="note_paziente">Note per il medico (opzionale)</label>
                <textarea id="note_paziente" name="note_paziente" class="form-control" rows="3" placeholder="Es. motivo della visita, farmaci assunti, allergie..."></textarea>
            </div>
            <button type="submit" class="btn-form">Conferma la mia prenotazione</button>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const bookingModal = document.getElementById('booking-modal');
    const bookingForm = document.getElementById('booking-form');
    const bookingDetails = document.getElementById('booking-modal-details');
    const notesInput = document.getElementById('note_paziente');
    
    // Variabile globale per tenere traccia dello slot selezionato
    let selectedSlotId = null;

    /**
     * Funzione per generare le stelle del punteggio.
     * @param {number} punteggio - Il punteggio da 1 a 5.
     * @returns {string} - L'HTML delle stelle.
     */
    function generaStelle(punteggio) {
        let stelle = '';
        for (let i = 1; i <= 5; i++) {
            stelle += `<span class="star ${i <= punteggio ? 'filled' : ''}">&#9733;</span>`;
        }
        return `<div class="punteggio-stelle">${stelle}</div>`;
    }

    // Aggiungi questo stile per le stelle nel tag <head> o in un file CSS
    // Per semplicità, lo inseriamo qui dinamicamente
    const style = document.createElement('style');
    style.innerHTML = `
        .punteggio-stelle .star {
            color: #ddd; /* Grigio per le stelle vuote */
            font-size: 1.5rem;
        }
        .punteggio-stelle .star.filled {
            color: #ffc107; /* Giallo per le stelle piene */
        }
        .recensione-card {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        .recensione-card:last-child {
            border-bottom: none;
        }
        .recensione-card p {
            margin: 5px 0;
        }
        .recensione-data {
            font-size: 0.9rem;
            color: #888;
        }
    `;
    document.head.appendChild(style);

    window.addEventListener('DOMContentLoaded', async () => {
        const pathParts = window.location.pathname.split('/');
        const medicoId = pathParts[pathParts.length - 1];
        
        const containerDisponibilita = document.getElementById('disponibilita-lista');
        const containerRecensioni = document.getElementById('recensioni-lista');
        const isLoggedIn = !!localStorage.getItem('user_token');
        if(!isLoggedIn) {
            document.getElementById('auth-message').classList.remove('hidden');
        }

        // Caricamento in parallelo delle informazioni del medico e delle recensioni
        try {
            const [medico, disponibilita, valutazioni] = await Promise.all([
                callApi(`/medici/api/${medicoId}/details`),
                callApi(`/medici/api/${medicoId}/disponibilita?solo_libere=true`),
                callApi(`/medici/api/${medicoId}/valutazioni`) // Nuova chiamata
            ]);

            // Popola i dettagli del medico
            document.getElementById('medico-nome').textContent = `Dr. ${medico.nome} ${medico.cognome}`;
            document.getElementById('medico-specializzazione').textContent = medico.specializzazione_nome;
            document.getElementById('medico-citta').textContent = medico.citta;
            document.getElementById('medico-indirizzo').textContent = medico.indirizzo_studio;
            document.getElementById('medico-punteggio').textContent = medico.punteggio_medio.toFixed(2);
            document.title = `Profilo Dr. ${medico.nome} ${medico.cognome} - MediClick`;
            
            // Popola le disponibilità
            containerDisponibilita.innerHTML = ''; 
            if (disponibilita.length === 0) {
                containerDisponibilita.innerHTML = '<li class="disabled">Nessuna disponibilità trovata.</li>';
            } else {
                disponibilita.forEach(slot => {
                    const li = document.createElement('li');
                    const dataInizio = new Date(slot.data_ora_inizio);
                    li.textContent = `${dataInizio.toLocaleDateString('it-IT', { dateStyle: 'long' })} - ${dataInizio.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}`;
                    
                    if (isLoggedIn) {
                        li.dataset.slotId = slot.id;
                        li.addEventListener('click', () => openBookingModal(slot.id, li.textContent));
                    } else {
                        li.classList.add('disabled');
                    }
                    containerDisponibilita.appendChild(li);
                });
            }

            // Popola le recensioni
            containerRecensioni.innerHTML = '';
            if (valutazioni.length === 0) {
                containerRecensioni.innerHTML = '<p>Nessuna recensione trovata per questo medico.</p>';
            } else {
                valutazioni.forEach(val => {
                    const div = document.createElement('div');
                    div.className = 'recensione-card';
                    const dataValutazione = new Date(val.data_valutazione);

                    div.innerHTML = `
                        ${generaStelle(val.punteggio)}
                        <p>${val.commento || '<i>Nessun commento lasciato.</i>'}</p>
                        <p class="recensione-data">Recensito il: ${dataValutazione.toLocaleDateString('it-IT')}</p>
                    `;
                    containerRecensioni.appendChild(div);
                });
            }

        } catch (error) {
            console.error("Errore caricamento dati medico o recensioni:", error);
            document.querySelector('.page-header').innerHTML = '<h1>Medico non trovato</h1><p>Errore nel recupero delle informazioni.</p>';
            containerRecensioni.innerHTML = '<p>Impossibile caricare le recensioni.</p>';
        }
    });

    /**
     * Apre il modale di prenotazione, impostando i dati corretti.
     * @param {number} slotId - L'ID dello slot di disponibilità.
     * @param {string} slotText - Il testo descrittivo dello slot.
     */
    function openBookingModal(slotId, slotText) {
        selectedSlotId = slotId;
        bookingDetails.textContent = slotText;
        bookingForm.reset();
        bookingModal.style.display = 'block';
    }

    /**
     * Chiude il modale di prenotazione.
     */
    function closeBookingModal() {
        bookingModal.style.display = 'none';
        selectedSlotId = null;
    }

    // Aggiungiamo il listener per l'invio del form del modale
    bookingForm.addEventListener('submit', async (event) => {
        event.preventDefault(); 
        if (!selectedSlotId) return;

        const notePaziente = notesInput.value.trim();

        const payload = {
            disponibilita_id: parseInt(selectedSlotId),
            note_paziente: notePaziente
        };

        try {
            await callApi('/api/prenotazioni', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            closeBookingModal(); 
            SalusNotifier.alert('Prenotazione confermata con successo! Sarai reindirizzato al tuo profilo tra pochi secondi.', 'Prenotazione Effettuata');
            setTimeout(() => window.location.href = '/profilo', 3000);

        } catch(error) {
            console.error("Errore prenotazione:", error);
            closeBookingModal();
            SalusNotifier.alert(`Errore durante la prenotazione: ${error.message}`, 'Errore di Prenotazione');
        }
    });

</script>
{% endblock %}