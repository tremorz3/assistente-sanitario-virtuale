{% extends "layouts/base.html" %}

{% block title %}Elenco Medici - Salus AI{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Trova il Tuo Specialista</h1>
    <p>Usa i filtri per affinare la ricerca e trovare il professionista più adatto a te.</p>
</div>

<div class="filters-container">
    <div class="form-group filter-group">
        <label for="spec-search">Filtra per Specializzazione</label>
        <div class="autocomplete-container">
            <input type="text" id="spec-search" placeholder="Digita per cercare una specializzazione..." autocomplete="off" class="form-control">
            <div class="autocomplete-items" id="spec-suggestions"></div>
        </div>
    </div>

    <div class="form-group filter-group">
        <label for="sort-by">Ordina per</label>
        <select id="sort-by" class="form-control">
            <option value="punteggio">Punteggio (dal più alto)</option>
            <option value="cognome">Cognome (A-Z)</option>
        </select>
    </div>
</div>

<div id="medici-container" class="medici-grid">
    <p>Caricamento dei medici in corso...</p>
</div>
{% endblock %}

{% block scripts %}
<script>
    window.addEventListener('DOMContentLoaded', async () => {
        // Riferimenti agli elementi del DOM
        const mediciContainer = document.getElementById('medici-container');
        const sortSelect = document.getElementById('sort-by');
        const specSearchInput = document.getElementById('spec-search');
        const specSuggestionsContainer = document.getElementById('spec-suggestions');

        // Stato dei filtri
        let allSpecializations = [];
        let selectedSpecId = null;
        let selectedSortBy = 'punteggio';
        let debounceTimer;

        /**
         * Funzione centrale per recuperare e mostrare i medici in base ai filtri.
         */
        async function fetchAndRenderMedici() {
            mediciContainer.innerHTML = '<p>Caricamento...</p>';
            
            // Costruisce l'URL dell'API con i parametri di filtro
            const params = new URLSearchParams();
            if (selectedSpecId) {
                params.append('specializzazione_id', selectedSpecId);
            }
            params.append('sort_by', selectedSortBy);
            
            const apiUrl = `/medici/api/list?${params.toString()}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`Errore: ${response.status}`);
                const medici = await response.json();
                
                renderMedici(medici);
            } catch (error) {
                console.error("Impossibile caricare la lista dei medici:", error);
                mediciContainer.innerHTML = '<p class="form-error">Si è verificato un errore. Riprova più tardi.</p>';
            }
        }

        /**
         * Funzione per renderizzare le card dei medici nel container.
         * @param {Array} medici - La lista dei medici da visualizzare.
         */
        function renderMedici(medici) {
            mediciContainer.innerHTML = '';
            if (medici.length === 0) {
                mediciContainer.innerHTML = '<p>Nessun medico trovato con i criteri selezionati.</p>';
                return;
            }

            medici.forEach(medico => {
                const card = document.createElement('div');
                card.className = 'medico-card';
                card.dataset.medicoId = medico.id;
                card.innerHTML = `
                    <h2>Dr. ${medico.nome} ${medico.cognome}</h2>
                    <p class="specializzazione">${medico.specializzazione_nome}</p>
                    <p>${medico.citta}</p>
                    <p>${medico.indirizzo_studio}</p>
                    <p class="punteggio">Punteggio: ${medico.punteggio_medio.toFixed(2)} / 5.00</p>
                `;
                
                card.addEventListener('click', () => {
                    const token = localStorage.getItem('user_token');
                    if (token) {
                        window.location.href = `/medici/${medico.id}`;
                    } else {
                        SalusNotifier.alert("Per visualizzare i dettagli del medico, è necessario effettuare l'accesso.", "Accesso Richiesto");
                        setTimeout(() => { window.location.href = '/pagina-login'; }, 2500);
                    }
                });
                mediciContainer.appendChild(card);
            });
        }

        /**
         * Popola il contenitore dei suggerimenti per le specializzazioni.
         * @param {Array} suggestions - Le specializzazioni da mostrare.
         */
        function showSpecSuggestions(suggestions) {
            specSuggestionsContainer.innerHTML = '';
            
            // Aggiunge l'opzione per rimuovere il filtro
            const allOption = document.createElement('div');
            allOption.textContent = 'Tutte le specializzazioni';
            allOption.addEventListener('click', () => {
                selectedSpecId = null;
                specSearchInput.value = '';
                specSuggestionsContainer.innerHTML = '';
                fetchAndRenderMedici();
            });
            specSuggestionsContainer.appendChild(allOption);

            suggestions.forEach(spec => {
                const suggestionDiv = document.createElement('div');
                suggestionDiv.textContent = spec.nome;
                suggestionDiv.addEventListener('click', () => {
                    specSearchInput.value = spec.nome;
                    selectedSpecId = spec.id;
                    specSuggestionsContainer.innerHTML = '';
                    fetchAndRenderMedici();
                });
                specSuggestionsContainer.appendChild(suggestionDiv);
            });
        }

        // --- INIZIALIZZAZIONE ---

        // 1. Recupera le specializzazioni per il filtro
        try {
            const response = await fetch('/api/specializzazioni'); // Proxy non necessario, endpoint pubblico
            allSpecializations = await response.json();
        } catch (error) {
            console.error("Impossibile caricare le specializzazioni", error);
        }
        
        // 2. Aggiunge gli event listener ai controlli
        sortSelect.addEventListener('change', (e) => {
            selectedSortBy = e.target.value;
            fetchAndRenderMedici();
        });

        specSearchInput.addEventListener('input', () => {
            const query = specSearchInput.value.toLowerCase();
            clearTimeout(debounceTimer);
            
            if (query.length === 0) {
                selectedSpecId = null;
                fetchAndRenderMedici();
            }

            debounceTimer = setTimeout(() => {
                const filtered = allSpecializations.filter(spec => 
                    spec.nome.toLowerCase().includes(query)
                );
                showSpecSuggestions(filtered);
            }, 300);
        });

        // Nasconde i suggerimenti se si clicca altrove nella pagina
        document.addEventListener('click', (e) => {
            if (e.target !== specSearchInput) {
                specSuggestionsContainer.innerHTML = '';
            }
        });

        // 3. Caricamento iniziale dei medici
        fetchAndRenderMedici();
    });
</script>
{% endblock %}