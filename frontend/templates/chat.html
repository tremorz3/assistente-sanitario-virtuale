<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Chat Sanitaria</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
        #chat-window { height: 300px; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; overflow-y: scroll; display: flex; flex-direction: column; }
        .chat-message { max-width: 80%; padding: 8px 12px; margin-bottom: 8px; border-radius: 18px; }
        .user-message { background-color: #007bff; color: white; align-self: flex-end; }
        .assistant-message { background-color: #e9e9eb; color: black; align-self: flex-start; }
        #chat-form { display: flex; }
        #chatInput { 
            flex-grow: 1; 
            padding: 10px; 
            border-radius: 20px; 
            border: 1px solid #ccc;
            /* 1. Aggiunto per impedire il ridimensionamento */
            resize: none; 
        }
        #chat-form button { 
            padding: 10px 20px; 
            margin-left: 10px; 
            border-radius: 20px; 
            border: none; 
            background-color: #007bff; 
            color: white; 
            cursor: pointer; 
        }
        #reset-button {
            background-color: #6c757d;
        }
    </style>
</head>
<body>

    <h1>Assistente Sanitario AI</h1>
    <div id="chat-window">
        <p class="chat-message assistant-message">Ciao! Sono il tuo assistente. Quando inizierai a scrivere, ti chieder√≤ la posizione per aiutarti a trovare gli specialisti pi√π vicini a te.</p>
    </div>

    <form id="chat-form">
        <textarea id="chatInput" placeholder="Scrivi qui il tuo messaggio..." rows="1"></textarea>
        <button type="submit">Invia</button>
        <button type="button" id="reset-button">Reset</button>
    </form>
    
    <div id="geo-status" style="font-size: 0.9em; color: #555; margin-top: 5px;"></div>

    <script>
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chatInput');
        const chatWindow = document.getElementById('chat-window');
        const geoStatus = document.getElementById('geo-status');
        const resetButton = document.getElementById('reset-button');

        let userLocation = null;

        // --- GESTIONE GEOLOCALIZZAZIONE ---
        chatInput.addEventListener('focus', () => {
            if (navigator.geolocation) {
                geoStatus.textContent = 'Per personalizzare i risultati, ti chiediamo la posizione...';
                navigator.geolocation.getCurrentPosition(posizioneOttenuta, errorePosizione);
            } else {
                geoStatus.textContent = "Geolocalizzazione non supportata da questo browser.";
            }
        }, { once: true });

        function posizioneOttenuta(posizione) {
            userLocation = { lat: posizione.coords.latitude, lon: posizione.coords.longitude };
            geoStatus.textContent = `üìç Posizione ottenuta. Ora puoi chiedere quello che vuoi!`;
        }
        function errorePosizione(errore) {
            geoStatus.textContent = `‚ö†Ô∏è Impossibile ottenere la posizione. I risultati non saranno geolocalizzati.`;
        }

        /* * 2. Aggiunto per gestire l'invio con il tasto Invio.
         * Permette di andare a capo con Shift + Invio.
         */
        chatInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                // Previene il comportamento di default (andare a capo)
                event.preventDefault();
                // Simula il click sul bottone di invio
                chatForm.dispatchEvent(new Event('submit', { cancelable: true }));
            }
        });

        // --- GESTIONE INVIO MESSAGGI CHAT ---
        chatForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            appendMessage(userMessage, 'user');
            chatInput.value = '';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domanda: userMessage, location: userLocation })
                });

                if (!response.ok) throw new Error(`Errore dal server: ${response.statusText}`);

                const aiData = await response.json();
                appendMessage(aiData.content, 'assistant');

            } catch (error) {
                console.error('Errore durante la chat:', error);
                appendMessage('Spiacente, si √® verificato un errore.', 'assistant');
            }
        });
        
        // --- GESTIONE RESET ---
        resetButton.addEventListener('click', async () => {
            try {
                const response = await fetch('/reset', { method: 'POST' });

                if (!response.ok) {
                    throw new Error(`Errore durante il reset: ${response.statusText}`);
                }
                
                chatWindow.innerHTML = '';
                appendMessage('Ciao! Sono il tuo assistente. Quando inizierai a scrivere, ti chieder√≤ la posizione per aiutarti a trovare gli specialisti pi√π vicini a te.', 'assistant');
                geoStatus.textContent = '';

            } catch (error) {
                console.error('Errore nel reset:', error);
                appendMessage('Non √® stato possibile resettare la conversazione.', 'assistant');
            }
        });

        // Funzione helper per aggiungere messaggi alla finestra della chat
        function appendMessage(text, role) {
            const messageElement = document.createElement('p');
            messageElement.textContent = text;
            messageElement.className = `chat-message ${role}-message`;
            chatWindow.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    </script>
</body>
</html>