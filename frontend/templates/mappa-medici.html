{% extends "layouts/base.html" %}

{% block title %}Cerca Medici su Mappa - Salus AI{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Ricerca Geografica</h1>
    <p>Trova gli specialisti più vicini a te o cerca in una località specifica.</p>
</div>

<div class="map-page-container">
    <div class="map-sidebar">
        <div class="map-controls">
            <div class="form-group">
                <label for="address-search">Cerca un indirizzo</label>
                <div class="autocomplete-container">
                    <input type="text" id="address-search" class="form-control" placeholder="Digita e seleziona un indirizzo..." autocomplete="off">
                    <div class="autocomplete-items" id="address-suggestions"></div>
                </div>
            </div>
            <button id="search-btn" class="btn-form" disabled>Cerca</button>
            <button id="geo-btn" class="btn-form secondary">Usa la mia posizione</button>
        </div>
        <div id="results-list-container">
            <p id="results-status">Usa la tua posizione o cerca un indirizzo per trovare i medici nelle vicinanze.</p>
            <ul id="results-list"></ul>
        </div>
    </div>

    <div id="map" class="map-container"></div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // ... (riferimenti agli elementi DOM invariati) ...
        const mapContainer = document.getElementById('map');
        const geoBtn = document.getElementById('geo-btn');
        const searchBtn = document.getElementById('search-btn');
        const addressInput = document.getElementById('address-search');
        const suggestionsContainer = document.getElementById('address-suggestions');
        const resultsStatus = document.getElementById('results-status');
        const resultsList = document.getElementById('results-list');

        let map;
        let doctorMarkersLayer = L.layerGroup(); // Layer per i marcatori dei medici
        let userMarkerLayer = L.layerGroup();   // Layer dedicato per il marcatore dell'utente
        let selectedCoords = null;
        let debounceTimer;

        const redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        function initializeMap() {
            map = L.map(mapContainer).setView([41.902782, 12.496366], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
            doctorMarkersLayer.addTo(map);
            userMarkerLayer.addTo(map); // Aggiunge il nuovo layer alla mappa
        }

        async function findNearbyDoctors(lat, lon) {
            resultsStatus.textContent = 'Ricerca dei medici in corso...';
            resultsList.innerHTML = '';
            doctorMarkersLayer.clearLayers(); // Rimuove i vecchi marcatori dei medici
            userMarkerLayer.clearLayers();   // Rimuove il vecchio marcatore dell'utente

            // ========= MODIFICA CHIAVE: Aggiunge il marcatore rosso =========
            // Aggiungiamo subito il marcatore rosso per dare un feedback immediato
            L.marker([lat, lon], { icon: redIcon }).addTo(userMarkerLayer)
                .bindPopup('La tua posizione di ricerca').openPopup();
            // ===============================================================
            
            try {
                const response = await callApi(`/medici/api/vicini?lat=${lat}&lon=${lon}`);
                
                if (response.length === 0) {
                    resultsStatus.textContent = 'Nessun medico trovato in un raggio di 20 km.';
                    return;
                }

                resultsStatus.textContent = `Trovati ${response.length} medici:`;
                const markerBounds = [[lat, lon]]; // Includi la posizione dell'utente nei limiti

                response.forEach(medico => {
                    const coords = [medico.latitudine, medico.longitudine];
                    markerBounds.push(coords);
                    const popupContent = `
                        <b>Dr. ${medico.nome} ${medico.cognome}</b><br>
                        ${medico.specializzazione_nome}<br>
                        <i>${medico.indirizzo_studio}</i><br>
                        Punteggio: ${medico.punteggio_medio.toFixed(2)}/5<br>
                        Distanza: ${medico.distanza_km.toFixed(1)} km<br>
                        <a href="/medici/${medico.id}">Vedi profilo</a>
                    `;
                    // I marcatori dei medici rimangono blu (default)
                    L.marker(coords).addTo(doctorMarkersLayer).bindPopup(popupContent);

                    const li = document.createElement('li');
                    li.className = 'doctor-list-item';
                    li.innerHTML = `
                        <h4>Dr. ${medico.nome} ${medico.cognome} (${medico.distanza_km.toFixed(1)} km)</h4>
                        <p>${medico.specializzazione_nome}</p>
                        <p class="address">${medico.indirizzo_studio}</p>
                    `;
                    li.addEventListener('click', () => {
                        map.setView(coords, 15);
                        doctorMarkersLayer.eachLayer(layer => {
                            if (layer.getLatLng().equals(L.latLng(coords))) {
                                layer.openPopup();
                            }
                        });
                    });
                    resultsList.appendChild(li);
                });

                map.fitBounds(markerBounds, { padding: [50, 50] });

            } catch (error) {
                SalusNotifier.alert(`Errore nella ricerca: ${error.message}`, 'Errore');
                resultsStatus.textContent = 'Si è verificato un errore durante la ricerca.';
            }
        }

        // ... (tutto il resto dello script, inclusa la logica di autocomplete e i listener, rimane invariato) ...
        function searchByAddress() {
            if (selectedCoords) {
                findNearbyDoctors(selectedCoords.lat, selectedCoords.lon);
            } else {
                SalusNotifier.alert('Per favore, seleziona un indirizzo valido dalla lista dei suggerimenti.', 'Selezione Richiesta');
            }
        }

        geoBtn.addEventListener('click', () => {
            if (!navigator.geolocation) {
                SalusNotifier.alert('La geolocalizzazione non è supportata da questo browser.', 'Errore');
                return;
            }
            resultsStatus.textContent = 'In attesa della tua posizione...';
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    findNearbyDoctors(position.coords.latitude, position.coords.longitude);
                },
                () => {
                    SalusNotifier.alert('Impossibile ottenere la posizione. Assicurati di aver dato i permessi.', 'Errore di Posizione');
                    resultsStatus.textContent = 'Permesso di geolocalizzazione negato.';
                }
            );
        });

        searchBtn.addEventListener('click', searchByAddress);

        addressInput.addEventListener('input', function() {
            const query = this.value;
            selectedCoords = null; 
            searchBtn.disabled = true; 
            clearTimeout(debounceTimer);
            suggestionsContainer.innerHTML = '';

            if (query.length < 3) return;

            debounceTimer = setTimeout(() => {
                fetch(`/api/autocomplete-address?query=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(suggestions => {
                        suggestionsContainer.innerHTML = '';
                        suggestions.forEach(suggestion => {
                            const suggestionDiv = document.createElement('div');
                            suggestionDiv.textContent = suggestion.display_address;
                            suggestionDiv.addEventListener('click', function() {
                                addressInput.value = suggestion.display_address;
                                selectedCoords = { lat: suggestion.lat, lon: suggestion.lon };
                                searchBtn.disabled = false;
                                suggestionsContainer.innerHTML = '';
                            });
                            suggestionsContainer.appendChild(suggestionDiv);
                        });
                    })
                    .catch(error => console.error('Errore autocomplete:', error));
            }, 300);
        });
        
        document.addEventListener('click', (e) => {
            if (e.target !== addressInput) {
                suggestionsContainer.innerHTML = '';
            }
        });

        initializeMap();
    });
</script>
{% endblock %}