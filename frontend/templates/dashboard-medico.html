{% extends "layouts/base.html" %}

{% block title %}Dashboard Medico - Salus AI{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Dashboard Medico</h1>
    <p>Benvenuto/a, <strong>Dr. <span id="user-name">...</span></strong>! Visualizza e gestisci i tuoi appuntamenti.</p>
</div>

<div class="dashboard-grid">
    <div class="card">
        <h2>Appuntamenti Attivi</h2>
        <div id="appuntamenti-futuri"><p>Caricamento...</p></div>
    </div>
    <div class="card">
        <h2>Appuntamenti Passati</h2>
        <div id="appuntamenti-passati"><p>Caricamento...</p></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    window.addEventListener('DOMContentLoaded', async () => {
        if (!localStorage.getItem('user_token')) {
            window.location.href = '/pagina-login';
            return;
        }
        
        try {
            const userData = await callApi('/me');
            document.getElementById('user-name').textContent = userData.nome;

            const prenotazioni = await callApi('/api/prenotazioni/medico/me');
            
            const futuriContainer = document.getElementById('appuntamenti-futuri');
            const passatiContainer = document.getElementById('appuntamenti-passati');
            futuriContainer.innerHTML = '';
            passatiContainer.innerHTML = '';

            // Definiamo la data e ora attuali una sola volta per coerenza
            const adesso = new Date();

            prenotazioni.sort((a, b) => new Date(a.data_ora_inizio) - new Date(b.data_ora_inizio));

            prenotazioni.forEach(p => {
                const dataVisita = new Date(p.data_ora_inizio);
                const card = document.createElement('div');
                card.className = 'appuntamento-card';
                
                let actionsHtml = '<div class="actions">';
                if (p.stato === 'Confermata') {
                    // --- INIZIO MODIFICA CHIAVE ---
                    // 1. Controlliamo se la data della visita è già passata.
                    const isAppuntamentoPassato = dataVisita < adesso;

                    // 2. Aggiungiamo l'attributo 'disabled' al pulsante se l'appuntamento non è ancora passato.
                    //    Aggiungiamo anche un 'title' per spiegare all'utente perché il pulsante è disabilitato.
                    actionsHtml += `<button 
                                        class="btn-complete" 
                                        onclick="handleCompleteClick(${p.id})" 
                                        ${!isAppuntamentoPassato ? 'disabled' : ''}
                                        title="${!isAppuntamentoPassato ? 'Puoi completare la visita solo dopo il suo orario' : 'Segna la visita come completata'}">
                                        Segna come Completata
                                    </button>`;
                    
                    actionsHtml += `<button class="btn-cancel" onclick="handleCancelClick(${p.id})">Cancella Visita</button>`;
                    // --- FINE MODIFICA CHIAVE ---
                }
                actionsHtml += '</div>';

                card.innerHTML = `
                    <h3>Paziente: ${p.paziente_nome} ${p.paziente_cognome}</h3>
                    <p><strong>Telefono:</strong> <a href="tel:${p.paziente_telefono}">${p.paziente_telefono}</a></p>
                    <p><strong>Data:</strong> ${dataVisita.toLocaleDateString('it-IT', {day: '2-digit', month: 'long', year: 'numeric'})} - ${dataVisita.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'})}</p>
                    <p><strong>Stato:</strong> ${p.stato}</p>
                    <p><strong>Note Paziente:</strong> <em>${p.note_paziente || 'Nessuna nota'}</em></p>
                    ${actionsHtml}
                `;
                
                if (p.stato === 'Completata' || p.stato === 'Cancellata') {
                    if (p.stato === 'Completata') card.classList.add('completato');
                    if (p.stato === 'Cancellata') card.classList.add('cancellato');
                    passatiContainer.prepend(card); 
                } else {
                    futuriContainer.appendChild(card);
                }
            });

            if(futuriContainer.innerHTML === '') futuriContainer.innerHTML = '<p>Nessun appuntamento da gestire.</p>';
            if(passatiContainer.innerHTML === '') passatiContainer.innerHTML = '<p>Nessun appuntamento passato.</p>';

        } catch (error) {
            SalusNotifier.alert(`Errore nel caricamento della dashboard: ${error.message}`, 'Errore');
        }
    });

    async function handleCompleteClick(prenotazioneId) {
        const userConfirmed = await SalusNotifier.confirm(
            "Vuoi davvero segnare questa visita come completata?",
            "Conferma Azione"
        );
        if (userConfirmed) {
            try {
                await callApi(`/api/prenotazioni/${prenotazioneId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stato: 'Completata' })
                });
                SalusNotifier.alert('Visita segnata come completata!', 'Successo');
                setTimeout(() => window.location.reload(), 1500);
            } catch (error) {
                SalusNotifier.alert(`Errore: ${error.message}`, 'Errore');
            }
        }
    }
    
    async function handleCancelClick(prenotazioneId) {
        const userConfirmed = await SalusNotifier.confirm(
            "Sei sicuro di voler cancellare questa prenotazione? L'azione è irreversibile.",
            "Conferma Cancellazione"
        );
        if (userConfirmed) {
            try {
                await callApi(`/api/prenotazioni/${prenotazioneId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stato: 'Cancellata' })
                });
                SalusNotifier.alert('Prenotazione cancellata con successo!', 'Successo');
                setTimeout(() => window.location.reload(), 1500);
            } catch (error) {
                SalusNotifier.alert(`Errore durante la cancellazione: ${error.message}`, 'Errore');
            }
        }
    }
</script>
{% endblock %}