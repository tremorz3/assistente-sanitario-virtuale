{% extends "layouts/base.html" %}

{% block title %}MediClick - Trova e Prenota il Tuo Specialista{% endblock %}

{% block content %}
<section class="hero-section">
    <h1>Trova e Prenota il Tuo Specialista</h1>
    <p class="subtitle">‚úì Specialisti verificati ‚úì Geolocalizzazione ‚úì Prenotazione rapida. La piattaforma che connette pazienti e medici nella tua zona.</p>
</section>

<section class="booking-section">
    <div class="booking-form-container">
        <div class="booking-input-group">
            <label for="spec-booking-search">Specializzazione</label>
            <div class="autocomplete-container">
                <input type="text" id="spec-booking-search" placeholder="Cerca specializzazione..." autocomplete="off" class="form-control booking-input">
                <div class="autocomplete-items" id="spec-booking-suggestions"></div>
            </div>
        </div>
        
        <div class="booking-input-group">
            <label for="location-booking-search">Citt√† o Indirizzo</label>
            <div class="autocomplete-container">
                <input type="text" id="location-booking-search" placeholder="Cerca posizione..." autocomplete="off" class="form-control booking-input">
                <div class="autocomplete-items" id="location-booking-suggestions"></div>
            </div>
        </div>
        
        <div class="booking-input-group">
            <button id="search-booking-btn" class="btn-form booking-search-btn">Cerca</button>
        </div>
    </div>
</section>

<section class="hero-section">
    <h2>Non sai a quale medico rivolgerti?</h2>
    <p class="subtitle">Descrivi i tuoi sintomi. MediClick AI ti aiuter√† a identificare lo specialista pi√π adatto per te.</p>
    
    <div id="chat-container">
        <div id="chat-window">
            <div class="chat-message assistant-message">
                <p>Ciao! Sono MediClick AI e sono qui per aiutarti.</p>
            </div>
        </div>
        <div id="auth-required-message" style="display: none;">
            <p>Per utilizzare la chat, √® necessario essere registrati. <a href="/pagina-login">Accedi</a> o <a href="/pagina-registrazione-paziente">Registrati come Paziente</a></p>
        </div>
        <form id="chat-form">
            <textarea id="chatInput" placeholder="Es. 'Ho un forte mal di schiena da alcuni giorni...'" rows="1"></textarea>
            <button type="submit" id="chat-submit-btn" aria-label="Invia messaggio">Invia</button>
            <button type="button" id="reset-chat-btn" style="display: none;">Restart</button>
        </form>
        <div class="chat-disclaimer">
            <small>MediClick AI pu√≤ fare errori e non si sostituisce ad un medico.</small>
        </div>
    </div>
</section>

<section class="features-section">
    <div class="feature-card">
        <h2>Per il Paziente</h2>
        <p>Trova rapidamente lo specialista pi√π adatto, prenota una visita in pochi click e gestisci i tuoi appuntamenti. Tutto in un unico posto.</p>
        <a href="/pagina-registrazione-paziente" class="btn-feature">Registrati Ora</a>
    </div>
    <div class="feature-card">
        <h2>Per il Medico</h2>
        <p>Entra a far parte del nostro network, gestisci le tue disponibilit√† in modo semplice e raggiungi nuovi pazienti ogni giorno.</p>
        <a href="/pagina-registrazione-medico" class="btn-feature">Unisciti a Noi</a>
    </div>
</section>
{% endblock %}

{% block scripts %}
<style>
@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.4;
    }
    30% {
        transform: translateY(-10px);
        opacity: 1;
    }
}
.typing-dots {
    display: flex;
    gap: 4px;
    align-items: center;
}

/* Styling for the specialist booking button */
.specialist-booking-container {
    margin-top: 15px !important;
    text-align: center !important;
}

.specialist-booking-btn {
    background-color: #28a745 !important; /* Success green */
    border: none !important;
    color: white !important;
    padding: 10px 20px !important;
    border-radius: 20px !important;
    cursor: pointer !important;
    transition: background-color 0.3s ease !important;
    font-family: 'Poppins', sans-serif !important;
    font-size: 1rem !important;
    font-weight: normal !important;
    max-width: 200px !important;
    width: auto !important;
    margin: 0 auto !important;
    display: block !important;
}

.specialist-booking-btn:hover {
    background-color: #218838 !important; /* Darker green on hover */
}
</style>
<script>
    // TypingIndicator √® definito in main.js - usa quello globale

    // Tutta la logica JavaScript per la chat
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chatInput');
    const chatWindow = document.getElementById('chat-window');
    const authRequiredMessage = document.getElementById('auth-required-message');
    const resetChatBtn = document.getElementById('reset-chat-btn');
    let userLocation = null;
    let isUserAuthenticated = false;
    let sessionId = localStorage.getItem('chat_session_id'); // Recupera da localStorage

    // Elementi per la sezione booking
    const specBookingSearch = document.getElementById('spec-booking-search');
    const specBookingSuggestions = document.getElementById('spec-booking-suggestions');
    const locationBookingSearch = document.getElementById('location-booking-search');
    const locationBookingSuggestions = document.getElementById('location-booking-suggestions');
    const searchBookingBtn = document.getElementById('search-booking-btn');
    
    // Dati per autocomplete
    let allSpecializations = [];
    let selectedSpecId = null;
    let selectedLocation = null;
    let selectedLocationCoords = null;
    let debounceTimer;

    // --- INIZIO MODIFICA: Rimuoviamo la lista statica delle citt√† ---
    // const italianRegionalCapitals = [ ... ]; // RIMOSSO
    // --- FINE MODIFICA ---

    function generateSessionId() {
        const newId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('chat_session_id', newId);
        return newId;
    }

    function checkAuthenticationAndInitializeChat() {
        isUserAuthenticated = true; 
        if (!sessionId) {
            sessionId = generateSessionId();
        }
        chatInput.disabled = false;
        chatInput.placeholder = "Es. 'Ho un forte mal di schiena da alcuni giorni...'";
        document.getElementById('chat-submit-btn').disabled = false;
        const welcomeMessage = chatWindow.querySelector('.assistant-message p');
        welcomeMessage.innerHTML = 'Ciao! Sono MediClick AI e sono qui per aiutarti.';
        showQuickActionButtons();
        authRequiredMessage.style.display = 'none';
        resetChatBtn.style.display = 'block';
    }

    chatInput.addEventListener('focus', () => {});
    
    chatInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            chatForm.dispatchEvent(new Event('submit', { cancelable: true }));
        }
    });

    chatForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const userMessage = chatInput.value.trim();
        if (!userMessage) return;
        appendMessage(userMessage, 'user');
        chatInput.value = '';
        chatInput.disabled = true;
        TypingIndicator.show();
        try {
            const token = localStorage.getItem('user_token');
            const headers = { 'Content-Type': 'application/json' };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            const response = await fetch('/chat/message', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ 
                    session_id: sessionId,
                    messages: [{ role: 'user', content: userMessage }]
                })
            });
            if (!response.ok) throw new Error(`Errore dal server: ${response.statusText}`);
            const aiData = await response.json();
            if (aiData.content) {
                appendMessage(aiData.content, 'assistant');
            }
        } catch (error) {
            console.error('Chat error:', error);
            appendMessage('Spiacente, si √® verificato un errore di comunicazione con il server.', 'assistant');
        } finally {
            setTimeout(() => {
                TypingIndicator.hide();
                chatInput.disabled = false;
                chatInput.focus();
            }, 500);
        }
    });

    function appendMessage(text, role) {
        const messageContainer = document.createElement('div');
        messageContainer.className = `chat-message ${role}-message`;
        const messageParagraph = document.createElement('p');
        messageParagraph.textContent = text;
        messageContainer.appendChild(messageParagraph);
        chatWindow.appendChild(messageContainer);
        if (role === 'assistant' && detectSpecialistRecommendation(text)) {
            const specialistInfo = extractSpecialistInfo(text);
            if (specialistInfo) {
                const bookingButton = createBookingButton(specialistInfo);
                chatWindow.appendChild(bookingButton);
                disableChatInput();
            }
        }
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    resetChatBtn.addEventListener('click', async () => {
        chatWindow.innerHTML = '';
        const welcomeMessageHTML = `<div class="chat-message assistant-message"><p>Ciao! Sono MediClick AI e sono qui per aiutarti.</p></div>`;
        chatWindow.innerHTML = welcomeMessageHTML;
        showQuickActionButtons();
        enableChatInput();
        try {
            const token = localStorage.getItem('user_token');
            const headers = { 'Content-Type': 'application/json' };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            const response = await fetch('/chat/reset', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ session_id: sessionId, messages: [] })
            });
            if (response.ok) {
                sessionId = generateSessionId();
            }
        } catch (error) {
            console.error('Chat reset error:', error);
        }
        chatInput.focus();
    });

    // FUNZIONI PER LA SEZIONE BOOKING

    async function loadSpecializations() {
        try {
            const response = await fetch('/api/specializzazioni');
            allSpecializations = await response.json();
        } catch (error) {
            console.error('Errore nel caricamento delle specializzazioni:', error);
        }
    }

    function showSpecBookingSuggestions(suggestions) {
        specBookingSuggestions.innerHTML = '';
        const limitedSuggestions = suggestions.slice(0, 8);
        limitedSuggestions.forEach(spec => {
            const div = document.createElement('div');
            div.textContent = spec.nome;
            div.addEventListener('click', () => {
                specBookingSearch.value = spec.nome;
                selectedSpecId = spec.id;
                specBookingSuggestions.innerHTML = '';
            });
            specBookingSuggestions.appendChild(div);
        });
        if (suggestions.length > 8) {
            const showAllDiv = document.createElement('div');
            showAllDiv.textContent = `Visualizza tutte (${suggestions.length})`;
            showAllDiv.className = 'show-all-option';
            showAllDiv.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                specBookingSuggestions.innerHTML = '';
                specBookingSuggestions.classList.add('show-all-active');
                suggestions.forEach(spec => {
                    const div = document.createElement('div');
                    div.textContent = spec.nome;
                    div.addEventListener('click', () => {
                        specBookingSearch.value = spec.nome;
                        selectedSpecId = spec.id;
                        specBookingSuggestions.innerHTML = '';
                        specBookingSuggestions.classList.remove('show-all-active');
                    });
                    specBookingSuggestions.appendChild(div);
                });
            });
            specBookingSuggestions.appendChild(showAllDiv);
        }
    }

    // --- INIZIO MODIFICA CHIAVE ---
    function showLocationBookingSuggestions(addressSuggestions = [], showNearMe = false) {
        locationBookingSuggestions.innerHTML = '';
        
        if (showNearMe && userLocation) {
            const nearMeDiv = document.createElement('div');
            nearMeDiv.textContent = 'üìç Vicino a me';
            nearMeDiv.className = 'near-me-option';
            nearMeDiv.addEventListener('click', () => {
                locationBookingSearch.value = 'Vicino a me';
                selectedLocation = 'near_me';
                selectedLocationCoords = userLocation;
                locationBookingSuggestions.innerHTML = '';
            });
            locationBookingSuggestions.appendChild(nearMeDiv);
        }

        // Rimuoviamo il ciclo che mostrava i suggerimenti statici.
        // Mostriamo solo i suggerimenti dinamici degli indirizzi.
        addressSuggestions.forEach(address => {
            const div = document.createElement('div');
            div.textContent = address.display_address;
            div.addEventListener('click', () => {
                locationBookingSearch.value = address.display_address;
                selectedLocation = address.display_address; // Salviamo l'indirizzo completo
                selectedLocationCoords = { lat: address.lat, lon: address.lon }; // E le coordinate
                locationBookingSuggestions.innerHTML = '';
            });
            locationBookingSuggestions.appendChild(div);
        });
    }
    // --- FINE MODIFICA CHIAVE ---

    specBookingSearch.addEventListener('focus', () => {
        if (allSpecializations.length > 0) {
            showSpecBookingSuggestions(allSpecializations);
        }
    });

    specBookingSearch.addEventListener('input', () => {
        const query = specBookingSearch.value.toLowerCase();
        clearTimeout(debounceTimer);
        if (query.length === 0) {
            selectedSpecId = null;
            showSpecBookingSuggestions(allSpecializations);
            return;
        }
        debounceTimer = setTimeout(() => {
            const filtered = allSpecializations.filter(spec => spec.nome.toLowerCase().includes(query));
            showSpecBookingSuggestions(filtered);
        }, 300);
    });

    locationBookingSearch.addEventListener('focus', () => {
        showLocationBookingSuggestions([], !!userLocation);
        if (!userLocation && navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = { lat: position.coords.latitude, lon: position.coords.longitude };
                    if (document.activeElement === locationBookingSearch) {
                        showLocationBookingSuggestions([], true);
                    }
                }, () => {}
            );
        }
    });

    locationBookingSearch.addEventListener('click', () => {
        showLocationBookingSuggestions([], !!userLocation);
    });
    
    // --- INIZIO MODIFICA CHIAVE ---
    locationBookingSearch.addEventListener('input', () => {
        const query = locationBookingSearch.value.toLowerCase();
        clearTimeout(debounceTimer);
        
        if (query.length < 3) { // Non cercare se la query √® troppo corta
            locationBookingSuggestions.innerHTML = '';
            // Pulisci i filtri di localizzazione se il campo √® vuoto
            if (query.length === 0) {
                 selectedLocation = null;
                 selectedLocationCoords = null;
            }
            return;
        }
        
        debounceTimer = setTimeout(async () => {
            try {
                // Chiama direttamente l'API per l'autocomplete degli indirizzi
                const response = await fetch(`/api/autocomplete-address?query=${encodeURIComponent(query)}`);
                const addresses = await response.json();
                showLocationBookingSuggestions(addresses, true);
            } catch (error) {
                console.error('Errore autocomplete indirizzi:', error);
            }
        }, 300);
    });
    // --- FINE MODIFICA CHIAVE ---

    searchBookingBtn.addEventListener('click', () => {
        const params = new URLSearchParams();
        
        if (selectedSpecId) {
            params.append('specializzazione_id', selectedSpecId);
        } else {
            const specValue = specBookingSearch.value.trim();
            if (specValue) {
                const matchingSpec = allSpecializations.find(spec => spec.nome.toLowerCase() === specValue.toLowerCase());
                if (matchingSpec) params.append('specializzazione_id', matchingSpec.id);
            }
        }
        
        // Logica di reindirizzamento aggiornata
        if (selectedLocation === 'near_me' && selectedLocationCoords) {
            params.append('lat', selectedLocationCoords.lat);
            params.append('lon', selectedLocationCoords.lon);
        } else if (selectedLocation) {
            // Se √® stato selezionato un indirizzo, usiamo le sue coordinate se disponibili
            if (selectedLocationCoords) {
                 params.append('lat', selectedLocationCoords.lat);
                 params.append('lon', selectedLocationCoords.lon);
            } else {
                // Altrimenti, usiamo il testo come filtro per la citt√† (fallback)
                params.append('citta', selectedLocation);
            }
        }
        
        window.location.href = `/medici?${params.toString()}`;
    });

    document.addEventListener('click', (e) => {
        if (e.target !== specBookingSearch && e.target !== locationBookingSearch) {
            specBookingSuggestions.innerHTML = '';
            locationBookingSuggestions.innerHTML = '';
        }
    });

    // ... (tutto il resto del codice della chat rimane invariato)
    
    function showQuickActionButtons() {
        if (!isUserAuthenticated) return;
        const existingButtons = chatWindow.querySelector('.quick-actions-container');
        if (existingButtons) existingButtons.remove();
        const quickActionsContainer = document.createElement('div');
        quickActionsContainer.className = 'quick-actions-container';
        quickActionsContainer.innerHTML = `<p class="quick-actions-text">Cosa posso fare per te?</p><button class="quick-action-btn" data-message="Non so a quale specialista rivolgermi, mi puoi aiutare?">ü©∫ Trova Specialista</button>`;
        chatWindow.appendChild(quickActionsContainer);
        chatInput.disabled = true;
        chatInput.placeholder = "Seleziona un'azione o attendi...";
        document.getElementById('chat-submit-btn').disabled = true;
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    
    chatWindow.addEventListener('click', function(e) {
        if (e.target.classList.contains('quick-action-btn')) {
            const message = e.target.getAttribute('data-message');
            const quickActionsContainer = chatWindow.querySelector('.quick-actions-container');
            if (quickActionsContainer) quickActionsContainer.remove();
            const existingBookingButtons = chatWindow.querySelectorAll('.specialist-booking-container');
            existingBookingButtons.forEach(btn => btn.remove());
            enableChatInput();
            appendMessage(message, 'user');
            chatInput.disabled = true;
            TypingIndicator.show();
            sendMessageToAPI(message);
        }
    });
    
    async function sendMessageToAPI(userMessage) {
        try {
            const token = localStorage.getItem('user_token');
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            const response = await fetch('/chat/message', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ 
                    session_id: sessionId,
                    messages: [{ role: 'user', content: userMessage }]
                })
            });
            if (!response.ok) throw new Error(`Errore dal server: ${response.statusText}`);
            const aiData = await response.json();
            if (aiData.content) appendMessage(aiData.content, 'assistant');
        } catch (error) {
            console.error('Chat error:', error);
            appendMessage('Spiacente, si √® verificato un errore di comunicazione con il server.', 'assistant');
        } finally {
            setTimeout(() => {
                TypingIndicator.hide();
                chatInput.disabled = false;
                chatInput.focus();
            }, 500);
        }
    }

    function detectSpecialistRecommendation(text) {
        const lowerText = text.toLowerCase();
        const specializationTriggers = [
            'allergologia', 'allergologo', 'andrologia', 'andrologo', 'angiologia', 'angiologo', 'audioprotesista',
            'cardiochirurgia', 'cardiochirurgo', 'cardiologia', 'cardiologo', 'chirurgia generale', 'chirurgo generale',
            'chirurgia maxillo-facciale', 'chirurgo maxillo-facciale', 'chirurgia plastica', 'chirurgo plastico', 'chirurgia estetica',
            'chirurgia toracica', 'chirurgo toracico', 'chirurgia vascolare', 'chirurgo vascolare',
            'dermatologia', 'dermatologo', 'venerologia', 'diabetologia', 'diabetologo',
            'dietologia', 'dietologo', 'nutrizionista', 'nutrizione', 'ematologia', 'ematologo',
            'endocrinologia', 'endocrinologo', 'epatologia', 'epatologo', 'fisiatria', 'fisiatra',
            'fisioterapia', 'fisioterapista', 'massofisioterapia', 'gastroenterologia', 'gastroenterologo',
            'geriatria', 'geriatra', 'ginecologia', 'ginecologo', 'immunologia', 'immunologo',
            'infettivologia', 'infettivologo', 'logopedia', 'logopedista', 'medicina dello sport', 'medico dello sport',
            'medicina legale', 'medico legale', 'medico di medicina generale', 'medicina generale', 'medico di base',
            'nefrologia', 'nefrologo', 'neurochirurgia', 'neurochirurgo', 'neurologia', 'neurologo',
            'odontoiatria', 'odontoiatra', 'dentista', 'ortodonzia', 'oftalmologia', 'oculistica', 'oculista',
            'oncologia', 'oncologo', 'ortopedia', 'ortopedico', 'osteopatia', 'osteopata',
            'otorinolaringoiatria', 'otorino', 'pediatria', 'pediatra', 'pneumologia', 'pneumologo',
            'podologia', 'podologo', 'psichiatria', 'psichiatra', 'radiologia', 'radiologo',
            'reumatologia', 'reumatologo', 'urologia', 'urologo'
        ];
        return specializationTriggers.some(trigger => lowerText.includes(trigger));
    }
    
    function extractSpecialistInfo(text) {
        if (!allSpecializations || allSpecializations.length === 0) return null;
        const lowerText = text.toLowerCase();
        const specializationMapping = {
            'allergologo': 'Allergologia', 'andrologo': 'Andrologia', 'angiologo': 'Angiologia',
            'cardiochirurgo': 'Cardiochirurgia', 'cardiologo': 'Cardiologia', 'chirurgo generale': 'Chirurgia Generale',
            'chirurgo maxillo-facciale': 'Chirurgia Maxillo-Facciale', 'chirurgo plastico': 'Chirurgia Plastica ed Estetica', 'chirurgia estetica': 'Chirurgia Plastica ed Estetica',
            'chirurgo toracico': 'Chirurgia Toracica', 'chirurgo vascolare': 'Chirurgia Vascolare',
            'dermatologo': 'Dermatologia e Venerologia', 'venerologia': 'Dermatologia e Venerologia', 'diabetologo': 'Diabetologia',
            'dietologo': 'Dietologia e Nutrizione', 'nutrizionista': 'Dietologia e Nutrizione', 'ematologo': 'Ematologia',
            'endocrinologo': 'Endocrinologia', 'epatologo': 'Epatologia', 'fisiatra': 'Fisiatria',
            'fisioterapista': 'Fisioterapia e Massofisioterapia', 'gastroenterologo': 'Gastroenterologia',
            'geriatra': 'Geriatria', 'ginecologo': 'Ginecologia', 'immunologo': 'Immunologia',
            'infettivologo': 'Infettivologia', 'logopedista': 'Logopedia', 'medico dello sport': 'Medicina dello Sport',
            'medico legale': 'Medicina Legale', 'medicina generale': 'Medico di Medicina Generale', 'medico di base': 'Medico di Medicina Generale',
            'nefrologo': 'Nefrologia', 'neurochirurgo': 'Neurochirurgia', 'neurologo': 'Neurologia',
            'odontoiatra': 'Odontoiatria e Ortodonzia', 'dentista': 'Odontoiatria e Ortodonzia', 'ortodonzia': 'Odontoiatria e Ortodonzia',
            'oftalmologo': 'Oftalmologia (Oculistica)', 'oculista': 'Oftalmologia (Oculistica)', 'oncologo': 'Oncologia',
            'ortopedico': 'Ortopedia', 'osteopata': 'Osteopatia', 'otorino': 'Otorinolaringoiatria',
            'pediatra': 'Pediatria', 'pneumologo': 'Pneumologia', 'podologo': 'Podologia',
            'psichiatra': 'Psichiatria', 'radiologo': 'Radiologia e Radiologia Diagnostica',
            'reumatologo': 'Reumatologia', 'urologo': 'Urologia'
        };
        for (const spec of allSpecializations) {
            if (lowerText.includes(spec.nome.toLowerCase())) return { id: spec.id, name: spec.nome };
        }
        for (const [variation, fullName] of Object.entries(specializationMapping)) {
            if (lowerText.includes(variation)) {
                const spec = allSpecializations.find(s => s.nome === fullName);
                if (spec) return { id: spec.id, name: spec.nome };
            }
        }
        return null;
    }
    
    function disableChatInput() {
        chatInput.disabled = true;
        chatInput.placeholder = "Clicca 'Prenota ora!' o inizia una nuova conversazione";
        document.getElementById('chat-submit-btn').disabled = true;
        resetChatBtn.style.display = 'block';
    }
    
    function enableChatInput() {
        chatInput.disabled = false;
        chatInput.placeholder = "Es. 'Ho un forte mal di schiena da alcuni giorni...'";
        document.getElementById('chat-submit-btn').disabled = false;
        chatInput.focus();
    }
    
    function createBookingButton(specialistInfo) {
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'specialist-booking-container';
        const bookingButton = document.createElement('button');
        bookingButton.className = 'quick-action-btn specialist-booking-btn';
        bookingButton.textContent = 'ü©∫ Prenota ora!';
        bookingButton.addEventListener('click', () => { handleBookingRedirect(specialistInfo); });
        buttonContainer.appendChild(bookingButton);
        return buttonContainer;
    }
    
    function handleBookingRedirect(specialistInfo) {
        const params = new URLSearchParams();
        params.append('specializzazione_id', specialistInfo.id);
        if (userLocation && userLocation.lat && userLocation.lon) {
            params.append('lat', userLocation.lat);
            params.append('lon', userLocation.lon);
        }
        window.location.href = `/medici?${params.toString()}`;
    }

    checkAuthenticationAndInitializeChat();
    loadSpecializations();
</script>
{% endblock %}